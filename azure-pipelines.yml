parameters:
  - name: TelemetryType
    displayName: Telemetry Type so that correct application insights key is selected
    default: 'TELEMETRY_DEVELOPMENT'
    values:
    - TELEMETRY_DEVELOPMENT
    - TELEMETRY_STAGING
    - TELEMETRY_PRODUCTION
  - name: BuildConfiguration
    displayName: BuildConfiguration to be used
    default: 'Release'
    values:
    - Release
    - Debug


trigger: none
name: $(date:yyyyMMdd)$(rev:.r)
resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/main


strategy:
  matrix:
    self-contained:
      win-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'win-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/windows/amd64/kubectl.exe'
        KubectlPath: 'win'
        KubectlFileName: 'kubectl.exe'
        ZipFilePathName: 'win'
        ZipFileName: 'lpk-win.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      win-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'win-arm64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/windows/arm64/kubectl.exe'
        KubectlPath: 'win'
        KubectlFileName: 'kubectl.exe'
        ZipFilePathName: 'win-arm64'
        ZipFileName: 'lpk-win-arm64.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      linux-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'linux-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/linux/amd64/kubectl'
        KubectlPath: 'linux'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'linux'
        ZipFileName: 'lpk-linux.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      linux-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'linux-arm64'
        SelfContained: true
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/linux/arm64/kubectl'
        KubectlPath: 'linux'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'linux-arm64'
        ZipFileName: 'lpk-linux-arm64.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      osx-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'osx-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/darwin/amd64/kubectl'
        KubectlPath: 'osx'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'osx'
        ZipFileName: 'lpk-osx.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      osx-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'osx-arm64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/darwin/arm64/kubectl'
        KubectlPath: 'osx'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'osx-arm64'
        ZipFileName: 'lpk-osx-arm64.zip'
        vmImage: 'macos-13-arm64'
    non-selfcontained:
      win-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'win-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/windows/amd64/kubectl.exe'
        KubectlPath: 'win'
        KubectlFileName: 'kubectl.exe'
        ZipFilePathName: 'win'
        ZipFileName: 'lpk-win.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      win-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'win-arm64'
        SelfContained: true
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/windows/arm64/kubectl.exe'
        KubectlPath: 'win'
        KubectlFileName: 'kubectl.exe'
        ZipFilePathName: 'win-arm64'
        ZipFileName: 'lpk-win-arm64.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      linux-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'linux-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/linux/amd64/kubectl'
        KubectlPath: 'linux'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'linux'
        ZipFileName: 'lpk-linux.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      linux-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'linux-arm64'
        SelfContained: true
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/linux/arm64/kubectl'
        KubectlPath: 'linux'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'linux-arm64'
        ZipFileName: 'lpk-linux-arm64.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      osx-x64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'osx-x64'
        SelfContained: false
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/darwin/amd64/kubectl'
        KubectlPath: 'osx'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'osx'
        ZipFileName: 'lpk-osx.zip'
        poolName: 'VSEngSS-MicroBuild2022-1ES'
      osx-arm64:
        TelemetryType: ${{ parameters.TelemetryType }}
        BuildConfiguration: ${{ parameters.BuildConfiguration }}
        BuildPlatform: 'osx-arm64'
        SelfContained: true
        KubectlDownloadUrl: 'https://dl.k8s.io/release/v1.27.3/bin/darwin/arm64/kubectl'
        KubectlPath: 'osx'
        KubectlFileName: 'kubectl'
        ZipFilePathName: 'osx-arm64'
        ZipFileName: 'lpk-osx-arm64.zip'
        vmImage: 'macos-13-arm64'


jobs:
- job: Build
  steps:
  - template: templates/build.yml
    parameters:
      TelemetryType: ${{ matrix.TelemetryType }}
      BuildConfiguration: ${{ matrix.BuildConfiguration }}
      BuildPlatform: ${{ matrix.BuildPlatform }}
      SelfContained: ${{ matrix.SelfContained }}
      KubectlDownloadUrl: ${{ matrix.KubectlDownloadUrl }}
      KubectlPath: ${{ matrix.KubectlPath }}
      KubectlFileName: ${{ matrix.KubectlFileName }}
      ZipFilePathName: ${{ matrix.ZipFilePathName }}
      ZipFileName: ${{ matrix.ZipFileName }}
      poolName: ${{ matrix.poolName }}
      vmImage: ${{ matrix.vmImage }}
- job: lks.json
  steps:
  - template: templates/generate-lks.yml
    condition: and(succeeded())
